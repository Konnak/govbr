{% extends 'base.html' %}
{% load static %}

{% block title %}Protocolo {{ protocolo.numero_protocolo }} - GovBR Roleplay{% endblock %}

{% block extra_css %}
<style>
.protocolo-detalhe {
    padding: 1rem 0;
    background: #f8f9fa;
    min-height: 100vh;
}

.protocolo-header {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.protocolo-numero {
    font-size: 1.8rem;
    font-weight: 700;
    color: #0066cc;
    margin-bottom: 0.5rem;
}

.protocolo-titulo {
    font-size: 1.2rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 1rem;
}

.status-badges {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 1rem;
}

.status-badge {
    padding: 4px 12px;
    border-radius: 15px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.status-aberto { background: #e3f2fd; color: #1565c0; }
.status-concluido { background: #e8f5e8; color: #2e7d32; }
.status-urgente { background: #ffebee; color: #c62828; }

.protocolo-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

.info-section {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    overflow: hidden;
}

.section-header {
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
    padding: 12px 16px;
    font-weight: 600;
    color: #495057;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.section-content {
    padding: 16px;
}

.info-row {
    display: flex;
    padding: 8px 0;
    border-bottom: 1px solid #f1f3f4;
}

.info-row:last-child {
    border-bottom: none;
}

.info-label {
    font-weight: 600;
    color: #495057;
    min-width: 140px;
    font-size: 0.9rem;
}

.info-value {
    color: #333;
    font-size: 0.9rem;
    flex: 1;
}

.full-width {
    grid-column: 1 / -1;
}

.documento-item {
    display: flex;
    align-items: center;
    padding: 12px;
    border-bottom: 1px solid #f1f3f4;
    transition: background-color 0.2s;
}

.documento-item:hover {
    background-color: #f8f9fa;
}

.documento-item:last-child {
    border-bottom: none;
}

.documento-icon {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 12px;
    font-size: 1.2rem;
}

.documento-info {
    flex: 1;
}

.documento-nome {
    font-weight: 500;
    color: #333;
    margin-bottom: 2px;
}

.documento-meta {
    font-size: 0.8rem;
    color: #6c757d;
}

.documento-actions {
    display: flex;
    gap: 8px;
}

.btn-action {
    padding: 4px 8px;
    font-size: 0.75rem;
    border-radius: 4px;
    border: 1px solid;
    background: white;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-download { border-color: #007bff; color: #007bff; }
.btn-download:hover { background: #007bff; color: white; }

.btn-sign { border-color: #28a745; color: #28a745; }
.btn-sign:hover { background: #28a745; color: white; }

.btn-reject { border-color: #dc3545; color: #dc3545; }
.btn-reject:hover { background: #dc3545; color: white; }

.btn-delete { border-color: #6c757d; color: #6c757d; }
.btn-delete:hover { background: #6c757d; color: white; }

.interessado-item {
    display: flex;
    align-items: center;
    padding: 10px 12px;
    border-bottom: 1px solid #f1f3f4;
}

.interessado-item:last-child {
    border-bottom: none;
}

.interessado-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: #e9ecef;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 12px;
    font-size: 0.9rem;
    color: #6c757d;
}

.encaminhamento-item {
    padding: 12px;
    border-bottom: 1px solid #f1f3f4;
    border-left: 4px solid #007bff;
    margin-bottom: 8px;
    background: #f8f9fa;
}

.encaminhamento-item:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.encaminhamento-header {
    font-weight: 600;
    color: #333;
    margin-bottom: 4px;
}

.encaminhamento-meta {
    font-size: 0.8rem;
    color: #6c757d;
    margin-bottom: 8px;
}

.encaminhamento-parecer {
    font-size: 0.9rem;
    color: #495057;
    background: white;
    padding: 8px;
    border-radius: 4px;
    border: 1px solid #dee2e6;
}

.assinaturas-status {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
}

.assinatura-item .badge {
    font-size: 0.7rem;
    padding: 2px 6px;
}

.actions-bar {
    position: sticky;
    top: 0;
    background: white;
    border-bottom: 1px solid #dee2e6;
    padding: 12px 0;
    margin-bottom: 20px;
    z-index: 100;
}

.btn-primary-action {
    background: #007bff;
    color: white;
    border: 1px solid #007bff;
    padding: 8px 16px;
    border-radius: 4px;
    margin-right: 8px;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-primary-action:hover {
    background: #0056b3;
    border-color: #0056b3;
}

.btn-secondary-action {
    background: white;
    color: #6c757d;
    border: 1px solid #6c757d;
    padding: 8px 16px;
    border-radius: 4px;
    margin-right: 8px;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
}

.btn-secondary-action:hover {
    background: #6c757d;
    color: white;
    text-decoration: none;
}

@media (max-width: 768px) {
    .protocolo-grid {
        grid-template-columns: 1fr;
    }
    
    .info-row {
        flex-direction: column;
    }
    
    .info-label {
        min-width: auto;
        margin-bottom: 4px;
    }
}

/* Estilos da Timeline de Movimentações */
.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 15px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #e9ecef;
}

.timeline-item {
    position: relative;
    margin-bottom: 30px;
    padding-bottom: 20px;
}

.timeline-item:last-child {
    margin-bottom: 0;
    padding-bottom: 0;
}

.timeline-marker {
    position: absolute;
    left: -23px;
    top: 5px;
    width: 30px;
    height: 30px;
    background: white;
    border: 2px solid #dee2e6;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
}

.timeline-content {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    margin-left: 20px;
}

.timeline-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid #e9ecef;
}

.timeline-title {
    color: #495057;
    font-size: 1rem;
}

.timeline-date {
    color: #6c757d;
    font-size: 0.85rem;
    font-family: 'Courier New', monospace;
}

.timeline-details {
    font-size: 0.9rem;
}

.movimentacao-origem,
.movimentacao-destino {
    margin-bottom: 8px;
}

.movimentacao-parecer {
    margin-top: 12px;
}

.timeline-details .label {
    font-weight: 600;
    color: #495057;
    margin-right: 8px;
}

.timeline-details .value {
    color: #6c757d;
}

.parecer-content {
    margin-top: 5px;
    padding: 10px;
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    white-space: pre-wrap;
    line-height: 1.5;
    color: #333;
}
</style>
{% endblock %}

{% block content %}
<div class="protocolo-detalhe">
    <div class="container-fluid">
        <!-- Barra de Ações -->
        <div class="actions-bar">
            <div class="container">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Protocolo Geral do Estado do Paraná</h4>
                    <div>
                        <a href="{% url 'main:protocolos_home' %}" class="btn-secondary-action">
                            <i class="fas fa-arrow-left"></i> Voltar
                        </a>
                        {% if pode_gerenciar %}
                            <button class="btn-primary-action" onclick="abrirModalEncaminhar()">
                                <i class="fas fa-share"></i> Encaminhar
                            </button>
                        {% endif %}
                        {% if protocolo.usuario_cadastro == user and protocolo.monitorado_por_usuario %}
                            <button class="btn-secondary-action" onclick="pararMonitorar()" style="background: #dc3545; color: white;">
                                <i class="fas fa-star-slash"></i> Parar de Monitorar
                            </button>
                        {% endif %}
                        <a href="{% url 'main:protocolo_documento_consolidado_pdf' protocolo.numero_protocolo %}" class="btn-primary-action">
                            <i class="fas fa-file-pdf"></i> Documento Consolidado
                        </a>
                        <button class="btn-secondary-action" onclick="window.print()">
                            <i class="fas fa-print"></i> Imprimir
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="container">

            <!-- Cabeçalho do Protocolo -->
            <div class="protocolo-header">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="protocolo-numero">{{ protocolo.numero_protocolo }}</div>
                        <div class="protocolo-titulo">{{ protocolo.assunto }}</div>
                        <div class="status-badges">
                            <span class="status-badge status-{{ protocolo.status }}">{{ protocolo.get_status_display }}</span>
                            {% if protocolo.urgencia == 'sim' %}
                                <span class="status-badge status-urgente">
                                    <i class="fas fa-exclamation-triangle"></i> URGENTE
                                </span>
                            {% endif %}
                            <span class="status-badge" style="background: #e8f4fd; color: #1976d2;">
                                {{ protocolo.nivel_acesso|title }}
                            </span>
                        </div>
                    </div>
                    <div>
                        <div class="text-end">
                            <div class="small text-muted">Situação: <strong>{{ protocolo.get_status_display }}</strong></div>
                            <div class="small text-muted">Cadastrado em: {{ protocolo.data_cadastro|date:"d/m/Y H:i" }}</div>
                            <div class="small text-muted">Última Atualização: {{ protocolo.data_cadastro|date:"d/m/Y H:i" }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Grid de Informações -->
            <div class="protocolo-grid">
                <!-- Informações Básicas -->
                <div class="info-section">
                    <div class="section-header">
                        <i class="fas fa-info-circle"></i> Informações Básicas
                    </div>
                    <div class="section-content">
                        <div class="info-row">
                            <div class="info-label">Espécie de Documento:</div>
                            <div class="info-value">{{ protocolo.especie_documento.nome }}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Data de Cadastro:</div>
                            <div class="info-value">{{ protocolo.data_cadastro|date:"d/m/Y H:i" }}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Usuário de Cadastro:</div>
                            <div class="info-value">{{ protocolo.usuario_cadastro.nome_completo_rp }}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Órgão de Origem:</div>
                            <div class="info-value">{{ protocolo.orgao_cadastro.nome|default:"Cidadão" }}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Setor de Origem:</div>
                            <div class="info-value">{{ protocolo.entidade_cadastro.nome|default:"Cidadão" }}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Prioridade:</div>
                            <div class="info-value">
                                {% if protocolo.urgencia == 'sim' %}
                                    <span style="color: #dc3545; font-weight: 600;">Sim</span>
                                {% else %}
                                    Não
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Informações de Destino -->
                <div class="info-section">
                    <div class="section-header">
                        <i class="fas fa-route"></i> Destinatário
                    </div>
                    <div class="section-content">
                        <div class="info-row">
                            <div class="info-label">Órgão Destinatário:</div>
                            <div class="info-value">{{ protocolo.orgao_destinatario.nome|default:"Não definido" }}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Setor Destinatário:</div>
                            <div class="info-value">{{ protocolo.entidade_destinatario.nome|default:"Não definido" }}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Destinatário Específico:</div>
                            <div class="info-value">{{ protocolo.usuario_destinatario.nome_completo_rp|default:"Não definido" }}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Restrição de Acesso:</div>
                            <div class="info-value">{{ protocolo.get_nivel_acesso_display }}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Última Atualização:</div>
                            <div class="info-value">{{ protocolo.data_cadastro|date:"d/m/Y H:i" }}</div>
                        </div>
                    </div>
                </div>

                <!-- Detalhamento -->
                <div class="info-section full-width">
                    <div class="section-header">
                        <i class="fas fa-align-left"></i> Detalhamento
                    </div>
                    <div class="section-content">
                        <div style="white-space: pre-wrap; line-height: 1.5;">{{ protocolo.detalhamento }}</div>
                    </div>
                </div>
            </div>

            <!-- Timeline de Movimentações -->
            <div class="info-section full-width" style="margin-bottom: 20px;">
                <div class="section-header">
                    <i class="fas fa-timeline"></i> Histórico de Movimentações
                </div>
                <div class="section-content">
                    <div class="timeline">
                        {% for movimentacao in movimentacoes_timeline %}
                        <div class="timeline-item">
                            <div class="timeline-marker">
                                {% if movimentacao.tipo == 'criacao' %}
                                    <i class="fas fa-plus-circle text-success"></i>
                                {% else %}
                                    <i class="fas fa-arrow-right text-primary"></i>
                                {% endif %}
                            </div>
                            <div class="timeline-content">
                                <div class="timeline-header">
                                    <div class="timeline-title">
                                        {% if movimentacao.tipo == 'criacao' %}
                                            <strong>Protocolo Criado</strong>
                                        {% else %}
                                            <strong>Encaminhamento</strong>
                                        {% endif %}
                                    </div>
                                    <div class="timeline-date">
                                        {{ movimentacao.data|date:"d/m/Y H:i" }}
                                    </div>
                                </div>
                                
                                <div class="timeline-details">
                                    <div class="movimentacao-origem">
                                        <span class="label">De:</span>
                                        <span class="value">
                                            {{ movimentacao.usuario_origem.nome_completo_rp }}
                                            {% if movimentacao.orgao_origem %}
                                                ({{ movimentacao.orgao_origem.nome }}{% if movimentacao.entidade_origem %} - {{ movimentacao.entidade_origem.nome }}{% endif %})
                                            {% else %}
                                                (Cidadão)
                                            {% endif %}
                                        </span>
                                    </div>
                                    
                                    {% if movimentacao.tipo != 'criacao' %}
                                    <div class="movimentacao-destino">
                                        <span class="label">Para:</span>
                                        <span class="value">
                                            {{ movimentacao.orgao_destino.nome }}
                                            {% if movimentacao.entidade_destino %} - {{ movimentacao.entidade_destino.nome }}{% endif %}
                                            {% if movimentacao.usuario_destino %} - {{ movimentacao.usuario_destino.nome_completo_rp }}{% endif %}
                                        </span>
                                    </div>
                                    {% endif %}
                                    
                                    <div class="movimentacao-parecer">
                                        <span class="label">
                                            {% if movimentacao.tipo == 'criacao' %}Detalhamento:{% else %}Parecer:{% endif %}
                                        </span>
                                        <div class="parecer-content">
                                            {% if movimentacao.tipo == 'criacao' %}
                                                {{ movimentacao.detalhamento|linebreaksbr }}
                                            {% else %}
                                                {{ movimentacao.parecer|linebreaksbr }}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Seções Secundárias -->
            <div class="protocolo-grid">
                <!-- Documentos do Processo -->
                <div class="info-section">
                    <div class="section-header">
                        <div class="d-flex justify-content-between align-items-center w-100">
                            <span><i class="fas fa-folder"></i> Documentos do Processo</span>
                            {% if pode_gerenciar %}
                                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#uploadDocumentoModal">
                                    <i class="fas fa-plus"></i> Adicionar
                                </button>
                            {% endif %}
                        </div>
                    </div>
                    <div class="section-content p-0">
                    
                        {% if documentos %}
                            {% for documento in documentos %}
                            <div class="documento-item" data-documento-id="{{ documento.id }}">
                                <div class="documento-icon">
                                    {% if documento.tipo == 'documento' %}
                                        📄
                                    {% elif documento.tipo == 'anexo' %}
                                        📎
                                    {% else %}
                                        📁
                                    {% endif %}
                                </div>
                                <div class="documento-info">
                                    <div class="documento-nome">
                                        {% if documento.identificador %}{{ documento.identificador }} - {% endif %}{{ documento.nome }}
                                    </div>
                                    <div class="documento-meta">
                                        Responsável: {{ documento.usuario_upload.nome_completo_rp }} | 
                                        Data Envio: {{ documento.data_upload|date:"d/m/Y H:i" }}
                                        {% if documento.assinado %}
                                            | <span style="color: #28a745; font-weight: 600;">✓ Assinado por {{ documento.usuario_assinatura.nome_completo_rp }} em {{ documento.data_assinatura|date:"d/m/Y H:i" }}</span>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Status das Solicitações de Assinatura -->
                                    {% if documento.solicitacoes_assinatura.all %}
                                        <div class="assinaturas-status mt-2">
                                            {% for solicitacao in documento.solicitacoes_assinatura.all %}
                                                <div class="assinatura-item">
                                                    {% if solicitacao.status == 'pendente' %}
                                                        <span class="badge bg-warning">⏳ Pendente: {{ solicitacao.usuario_destinatario.nome_completo_rp }}</span>
                                                    {% elif solicitacao.status == 'aceita' %}
                                                        <span class="badge bg-success">✓ Assinado: {{ solicitacao.usuario_destinatario.nome_completo_rp }}</span>
                                                    {% elif solicitacao.status == 'recusada' %}
                                                        <span class="badge bg-danger">✗ Rejeitado: {{ solicitacao.usuario_destinatario.nome_completo_rp }}</span>
                                                    {% endif %}
                                                </div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="documento-actions">
                                    <button class="btn-action btn-download" onclick="window.open('{{ documento.arquivo.url }}', '_blank')">
                                        <i class="fas fa-download"></i>
                                    </button>
                                    
                                    <!-- Verificar se há solicitação de assinatura pendente para o usuário atual -->
                                    {% for solicitacao in documento.solicitacoes_assinatura.all %}
                                        {% if solicitacao.usuario_destinatario == user and solicitacao.status == 'pendente' %}
                                            <button class="btn-action btn-sign" onclick="assinarDocumento({{ documento.id }})">
                                                <i class="fas fa-signature"></i>
                                            </button>
                                            <button class="btn-action btn-reject" onclick="rejeitarAssinatura({{ documento.id }})">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        {% endif %}
                                    {% endfor %}
                                    
                                    {% if pode_gerenciar %}
                                        <button class="btn-action btn-sign" onclick="solicitarAssinatura({{ documento.id }})">
                                            <i class="fas fa-signature"></i>
                                        </button>
                                        {% if documento.usuario_upload == user or pode_gerenciar %}
                                            <button class="btn-action btn-delete" onclick="excluirDocumento({{ documento.id }})">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div style="padding: 20px; text-align: center; color: #6c757d;">
                                <i class="fas fa-folder-open" style="font-size: 2rem; margin-bottom: 10px; color: #dee2e6;"></i>
                                <div>Nenhum documento anexado ao protocolo.</div>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Interessados -->
                <div class="info-section">
                    <div class="section-header">
                        <div class="d-flex justify-content-between align-items-center w-100">
                            <span><i class="fas fa-users"></i> Interessados</span>
                            {% if pode_gerenciar %}
                                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#adicionarInteressadoModal">
                                    <i class="fas fa-plus"></i> Adicionar
                                </button>
                            {% endif %}
                        </div>
                    </div>
                    <div class="section-content p-0">
                    
                        {% if interessados %}
                            {% for interessado in interessados %}
                            <div class="interessado-item" data-interessado-id="{{ interessado.id }}">
                                <div class="interessado-avatar">
                                    {{ interessado.usuario.nome_completo_rp|first|upper }}
                                </div>
                                <div class="interessado-info" style="flex: 1;">
                                    <div class="documento-nome">{{ interessado.usuario.nome_completo_rp }}</div>
                                    <div class="documento-meta">
                                        {{ interessado.orgao.nome|default:"Cidadão" }}{% if interessado.entidade %} - {{ interessado.entidade.nome }}{% endif %}
                                        <br>
                                        <small>Adicionado em {{ interessado.data_inclusao|date:"d/m/Y H:i" }}</small>
                                    </div>
                                </div>
                                {% if pode_gerenciar %}
                                <div>
                                    <button class="btn-action btn-delete" onclick="removerInteressado({{ interessado.id }})">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        {% else %}
                            <div style="padding: 20px; text-align: center; color: #6c757d;">
                                <i class="fas fa-users" style="font-size: 2rem; margin-bottom: 10px; color: #dee2e6;"></i>
                                <div>Nenhum interessado cadastrado.</div>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Histórico de Encaminhamentos (Resumido) -->
                <div class="info-section full-width">
                    <div class="section-header">
                        <div class="d-flex justify-content-between align-items-center w-100">
                            <span><i class="fas fa-history"></i> Histórico de Encaminhamentos</span>
                            {% if encaminhamentos %}
                                <a href="{% url 'main:protocolo_documento_consolidado' protocolo.numero_protocolo %}" class="btn btn-sm btn-outline-primary">
                                    Ver Completo ({{ encaminhamentos|length }})
                                </a>
                            {% endif %}
                        </div>
                    </div>
                    <div class="section-content p-0">
                        {% if encaminhamentos %}
                            {% for encaminhamento in encaminhamentos|slice:":3" %}
                            <div class="encaminhamento-item">
                                <div class="encaminhamento-header">
                                    {{ encaminhamento.usuario_origem.nome_completo_rp }} → 
                                    {{ encaminhamento.orgao_destino.nome }}{% if encaminhamento.entidade_destino %} - {{ encaminhamento.entidade_destino.nome }}{% endif %}{% if encaminhamento.usuario_destino %} - {{ encaminhamento.usuario_destino.nome_completo_rp }}{% endif %}
                                </div>
                                <div class="encaminhamento-meta">
                                    {{ encaminhamento.data_encaminhamento|date:"d/m/Y H:i" }}
                                </div>
                                <div class="encaminhamento-parecer">
                                    {{ encaminhamento.parecer|truncatechars:150 }}
                                </div>
                            </div>
                            {% endfor %}
                            {% if encaminhamentos|length > 3 %}
                            <div style="padding: 10px 16px; text-align: center; background: #f8f9fa; border-top: 1px solid #dee2e6;">
                                <small class="text-muted">
                                    Mostrando 3 de {{ encaminhamentos|length }} encaminhamentos. 
                                    <a href="{% url 'main:protocolo_documento_consolidado_pdf' protocolo.numero_protocolo %}">Ver todos no documento consolidado</a>
                                </small>
                            </div>
                            {% endif %}
                        {% else %}
                            <div style="padding: 20px; text-align: center; color: #6c757d;">
                                <i class="fas fa-route" style="font-size: 2rem; margin-bottom: 10px; color: #dee2e6;"></i>
                                <div>Nenhum encaminhamento registrado.</div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>



        <!-- Solicitações de Acesso -->
        {% if solicitacoes_acesso and pode_gerenciar %}
        <div class="protocolo-card">
            <h3 class="section-title">
                <i class="fas fa-key"></i>
                Solicitações de Acesso ({{ solicitacoes_acesso|length }})
            </h3>
            
            {% for solicitacao in solicitacoes_acesso %}
            <div class="documento-item">
                <div class="documento-info">
                    <div class="documento-icon">
                        <i class="fas fa-user-lock"></i>
                    </div>
                    <div>
                        <div class="documento-nome">{{ solicitacao.usuario_solicitante.nome_completo_rp }}</div>
                        <div class="documento-meta">
                            Status: {{ solicitacao.get_status_display }} | 
                            Solicitado em {{ solicitacao.data_solicitacao|date:"d/m/Y H:i" }}
                            <br>
                            <strong>Justificativa:</strong> {{ solicitacao.justificativa|truncatechars:100 }}
                        </div>
                    </div>
                </div>
                {% if solicitacao.status == 'pendente' %}
                <div>
                    <button class="btn btn-success btn-sm me-2">
                        <i class="fas fa-check"></i>
                        Aprovar
                    </button>
                    <button class="btn btn-danger btn-sm">
                        <i class="fas fa-times"></i>
                        Rejeitar
                    </button>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
</div>

<!-- Modais -->

<!-- Modal Upload Documento -->
<div class="modal fade" id="uploadDocumentoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-upload"></i>
                    Adicionar Documento
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="uploadDocumentoForm" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="nomeDocumento" class="form-label">Nome do Documento</label>
                        <input type="text" class="form-control" id="nomeDocumento" name="nome" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="tipoDocumento" class="form-label">Tipo</label>
                        <select class="form-select" id="tipoDocumento" name="tipo" required>
                            <option value="documento">Documento</option>
                            <option value="anexo">Anexo</option>
                            <option value="parecer">Parecer</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="arquivoDocumento" class="form-label">Arquivo</label>
                        <input type="file" class="form-control" id="arquivoDocumento" name="arquivo" required
                               accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.txt,.xlsx,.xls">
                        <div class="form-text">
                            Tipos permitidos: PDF, DOC, DOCX, JPG, PNG, TXT, XLS, XLSX (Máx: 10MB)
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-upload"></i> Enviar Documento
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Adicionar Interessado -->
<div class="modal fade" id="adicionarInteressadoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-plus"></i>
                    Adicionar Interessado
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="adicionarInteressadoForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="buscarUsuario" class="form-label">Buscar Usuário</label>
                        <input type="text" class="form-control" id="buscarUsuario" placeholder="Digite o nome ou username...">
                        <div id="resultadosBusca" class="mt-2"></div>
                        <input type="hidden" id="usuarioSelecionadoId" name="usuario_id">
                    </div>
                    
                    <div id="usuarioSelecionado" class="alert alert-info d-none">
                        <strong>Usuário selecionado:</strong> <span id="nomeUsuarioSelecionado"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" disabled id="btnAdicionarInteressado">
                        <i class="fas fa-plus"></i> Adicionar Interessado
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Encaminhar Protocolo -->
<div class="modal fade" id="encaminharProtocoloModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-share"></i>
                    Encaminhar Protocolo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="encaminharProtocoloForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="orgaoDestinoEncaminhar" class="form-label">Órgão de Destino *</label>
                            <select class="form-select" id="orgaoDestinoEncaminhar" name="orgao_destino_id" required>
                                <option value="">Selecione o órgão...</option>
                                {% for poder in poderes %}
                                    {% for orgao in poder.orgao_set.all %}
                                        <option value="{{ orgao.id }}">{{ orgao.nome }}</option>
                                    {% endfor %}
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="entidadeDestinoEncaminhar" class="form-label">Setor de Destino</label>
                            <select class="form-select" id="entidadeDestinoEncaminhar" name="entidade_destino_id">
                                <option value="">Selecione o setor...</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3 mt-3">
                        <label for="usuarioDestinoEncaminhar" class="form-label">Destinatário Específico</label>
                        <select class="form-select" id="usuarioDestinoEncaminhar" name="usuario_destino_id">
                            <option value="">Selecione o destinatário...</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="parecerEncaminhamento" class="form-label">Parecer *</label>
                        <textarea class="form-control" id="parecerEncaminhamento" name="parecer" rows="4" 
                                  placeholder="Digite o parecer do encaminhamento..." required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-share"></i> Encaminhar Protocolo
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Solicitar Assinatura -->
<div class="modal fade" id="solicitarAssinaturaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-signature"></i>
                    Solicitar Assinatura
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="solicitarAssinaturaForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="usuarioAssinatura" class="form-label">Destinatário *</label>
                        <select class="form-select" id="usuarioAssinatura" name="usuario_destinatario_id" required>
                            <option value="">Selecione o usuário...</option>
                            {% for interessado in interessados %}
                                <option value="{{ interessado.usuario.id }}">{{ interessado.usuario.nome_completo_rp }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="mensagemAssinatura" class="form-label">Mensagem (Opcional)</label>
                        <textarea class="form-control" id="mensagemAssinatura" name="mensagem" rows="3" 
                                  placeholder="Mensagem opcional para o destinatário..."></textarea>
                    </div>
                    
                    <input type="hidden" id="documentoAssinaturaId" name="documento_id">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-signature"></i> Enviar Solicitação
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Funcionalidades do Protocolo
document.addEventListener('DOMContentLoaded', function() {
    // Upload de Documento
    const uploadForm = document.getElementById('uploadDocumentoForm');
    if (uploadForm) {
        uploadForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
            
            fetch(`/protocolos/{{ protocolo.numero_protocolo }}/upload-documento/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('success', data.message);
                    bootstrap.Modal.getInstance(document.getElementById('uploadDocumentoModal')).hide();
                    uploadForm.reset();
                    location.reload(); // Recarregar para mostrar o novo documento
                } else {
                    showAlert('danger', data.error);
                }
            })
            .catch(error => {
                showAlert('danger', 'Erro ao enviar documento');
                console.error('Error:', error);
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            });
        });
    }
    
    // Buscar usuários para interessados
    const buscarUsuario = document.getElementById('buscarUsuario');
    if (buscarUsuario) {
        let timeoutId;
        buscarUsuario.addEventListener('input', function() {
            clearTimeout(timeoutId);
            const termo = this.value.trim();
            
            if (termo.length < 2) {
                document.getElementById('resultadosBusca').innerHTML = '';
                return;
            }
            
            timeoutId = setTimeout(() => {
                fetch(`/api/protocolos/buscar-usuarios/?q=${encodeURIComponent(termo)}`)
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('resultadosBusca');
                    container.innerHTML = '';
                    
                    if (data.usuarios && data.usuarios.length > 0) {
                        data.usuarios.forEach(usuario => {
                            const item = document.createElement('div');
                            item.className = 'list-group-item list-group-item-action cursor-pointer';
                            item.innerHTML = `
                                <strong>${usuario.nome_completo_rp}</strong>
                                <small class="text-muted d-block">@${usuario.username}</small>
                            `;
                            item.addEventListener('click', () => selecionarUsuario(usuario));
                            container.appendChild(item);
                        });
                    } else {
                        container.innerHTML = '<div class="text-muted">Nenhum usuário encontrado</div>';
                    }
                })
                .catch(error => console.error('Error:', error));
            }, 300);
        });
    }
    
    // Adicionar Interessado
    const interessadoForm = document.getElementById('adicionarInteressadoForm');
    if (interessadoForm) {
        interessadoForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const usuarioId = document.getElementById('usuarioSelecionadoId').value;
            if (!usuarioId) {
                showAlert('warning', 'Selecione um usuário');
                return;
            }
            
            const submitBtn = document.getElementById('btnAdicionarInteressado');
            const originalText = submitBtn.innerHTML;
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adicionando...';
            
            fetch(`/protocolos/{{ protocolo.numero_protocolo }}/adicionar-interessado/`, {
                method: 'POST',
                body: JSON.stringify({ usuario_id: parseInt(usuarioId) }),
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('success', data.message);
                    bootstrap.Modal.getInstance(document.getElementById('adicionarInteressadoModal')).hide();
                    location.reload(); // Recarregar para mostrar o novo interessado
                } else {
                    showAlert('danger', data.error);
                }
            })
            .catch(error => {
                showAlert('danger', 'Erro ao adicionar interessado');
                console.error('Error:', error);
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            });
        });
    }
    
    // Encaminhar Protocolo
    const encaminharForm = document.getElementById('encaminharProtocoloForm');
    if (encaminharForm) {
        // Carregar entidades quando órgão for selecionado
        document.getElementById('orgaoDestinoEncaminhar').addEventListener('change', function() {
            const orgaoId = this.value;
            const entidadeSelect = document.getElementById('entidadeDestinoEncaminhar');
            const usuarioSelect = document.getElementById('usuarioDestinoEncaminhar');
            
            entidadeSelect.innerHTML = '<option value="">Selecione o setor...</option>';
            usuarioSelect.innerHTML = '<option value="">Selecione o destinatário...</option>';
            
            if (orgaoId) {
                fetch(`/api/protocolos/entidades/${orgaoId}/`)
                .then(response => response.json())
                .then(data => {
                    data.entidades.forEach(entidade => {
                        const option = document.createElement('option');
                        option.value = entidade.id;
                        option.textContent = entidade.nome;
                        entidadeSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error:', error));
            }
        });
        
        // Carregar usuários quando entidade for selecionada
        document.getElementById('entidadeDestinoEncaminhar').addEventListener('change', function() {
            const entidadeId = this.value;
            const usuarioSelect = document.getElementById('usuarioDestinoEncaminhar');
            
            usuarioSelect.innerHTML = '<option value="">Selecione o destinatário...</option>';
            
            if (entidadeId) {
                fetch(`/api/protocolos/usuarios/${entidadeId}/`)
                .then(response => response.json())
                .then(data => {
                    data.usuarios.forEach(usuario => {
                        const option = document.createElement('option');
                        option.value = usuario.id;
                        option.textContent = usuario.nome_completo_rp;
                        usuarioSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error:', error));
            }
        });
        
        encaminharForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());
            
            // Converter IDs para números
            if (data.orgao_destino_id) data.orgao_destino_id = parseInt(data.orgao_destino_id);
            if (data.entidade_destino_id) data.entidade_destino_id = parseInt(data.entidade_destino_id);
            if (data.usuario_destino_id) data.usuario_destino_id = parseInt(data.usuario_destino_id);
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Encaminhando...';
            
            fetch(`/protocolos/{{ protocolo.numero_protocolo }}/encaminhar/`, {
                method: 'POST',
                body: JSON.stringify(data),
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('success', data.message);
                    bootstrap.Modal.getInstance(document.getElementById('encaminharProtocoloModal')).hide();
                    location.reload(); // Recarregar para mostrar o encaminhamento
                } else {
                    showAlert('danger', data.error);
                }
            })
            .catch(error => {
                showAlert('danger', 'Erro ao encaminhar protocolo');
                console.error('Error:', error);
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            });
        });
    }
    
    // Solicitar Assinatura
    const assinaturaForm = document.getElementById('solicitarAssinaturaForm');
    if (assinaturaForm) {
        assinaturaForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());
            
            // Converter IDs para números
            if (data.documento_id) data.documento_id = parseInt(data.documento_id);
            if (data.usuario_destinatario_id) data.usuario_destinatario_id = parseInt(data.usuario_destinatario_id);
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
            
            fetch(`/protocolos/{{ protocolo.numero_protocolo }}/solicitar-assinatura/`, {
                method: 'POST',
                body: JSON.stringify(data),
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('success', data.message);
                    bootstrap.Modal.getInstance(document.getElementById('solicitarAssinaturaModal')).hide();
                } else {
                    showAlert('danger', data.error);
                }
            })
            .catch(error => {
                showAlert('danger', 'Erro ao solicitar assinatura');
                console.error('Error:', error);
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            });
        });
    }
});

// Funções auxiliares
function selecionarUsuario(usuario) {
    document.getElementById('usuarioSelecionadoId').value = usuario.id;
    document.getElementById('nomeUsuarioSelecionado').textContent = usuario.nome_completo_rp;
    document.getElementById('usuarioSelecionado').classList.remove('d-none');
    document.getElementById('btnAdicionarInteressado').disabled = false;
    document.getElementById('resultadosBusca').innerHTML = '';
    document.getElementById('buscarUsuario').value = '';
}

function solicitarAssinatura(documentoId) {
    document.getElementById('documentoAssinaturaId').value = documentoId;
    new bootstrap.Modal(document.getElementById('solicitarAssinaturaModal')).show();
}

// Função para assinar documento
function assinarDocumento(documentoId) {
    const observacoes = prompt('Observações sobre a assinatura (opcional):');
    if (observacoes === null) return; // Usuário cancelou
    
    const dados = {
        observacoes: observacoes || ''
    };
    
    fetch(`/protocolos/{{ protocolo.numero_protocolo }}/assinar-documento/${documentoId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(dados)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            showAlert('danger', data.error);
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showAlert('danger', 'Erro ao assinar documento');
    });
}

// Função para rejeitar assinatura
function rejeitarAssinatura(documentoId) {
    const motivo = prompt('Motivo da rejeição (obrigatório):');
    if (!motivo || motivo.trim() === '') {
        showAlert('warning', 'Motivo da rejeição é obrigatório');
        return;
    }
    
    const dados = {
        motivo: motivo.trim()
    };
    
    fetch(`/protocolos/{{ protocolo.numero_protocolo }}/rejeitar-assinatura/${documentoId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(dados)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            showAlert('danger', data.error);
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showAlert('danger', 'Erro ao rejeitar assinatura');
    });
}

function removerInteressado(interessadoId) {
    if (!confirm('Tem certeza que deseja remover este interessado?')) return;
    
    fetch(`/protocolos/{{ protocolo.numero_protocolo }}/remover-interessado/${interessadoId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            document.querySelector(`[data-interessado-id="${interessadoId}"]`).remove();
        } else {
            showAlert('danger', data.error);
        }
    })
    .catch(error => {
        showAlert('danger', 'Erro ao remover interessado');
        console.error('Error:', error);
    });
}

function excluirDocumento(documentoId) {
    if (!confirm('Tem certeza que deseja excluir este documento?')) return;
    
    fetch(`/protocolos/{{ protocolo.numero_protocolo }}/excluir-documento/${documentoId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            document.querySelector(`[data-documento-id="${documentoId}"]`).remove();
        } else {
            showAlert('danger', data.error);
        }
    })
    .catch(error => {
        showAlert('danger', 'Erro ao excluir documento');
        console.error('Error:', error);
    });
}

function abrirModalEncaminhar() {
    new bootstrap.Modal(document.getElementById('encaminharProtocoloModal')).show();
}

// Função para parar de monitorar protocolo
function pararMonitorar() {
    if (!confirm('Tem certeza que deseja parar de monitorar este protocolo? Ele não aparecerá mais na sua lista de protocolos monitorados.')) {
        return;
    }
    
    fetch(`/protocolos/{{ protocolo.numero_protocolo }}/parar-monitorar/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            // Remover o botão ou recarregar a página
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            showAlert('danger', data.error);
        }
    })
    .catch(error => {
        showAlert('danger', 'Erro ao parar de monitorar protocolo');
        console.error('Error:', error);
    });
}

// Função para obter CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Função para mostrar alertas
function showAlert(type, message) {
    const alertContainer = document.getElementById('alert-container') || document.body;
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    alertContainer.appendChild(alert);
    
    // Auto-remover após 5 segundos
    setTimeout(() => {
        if (alert.parentNode) {
            alert.remove();
        }
    }, 5000);
}
</script>
{% endblock %} 